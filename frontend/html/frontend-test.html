<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UAPMP - Registration API Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
        text-align: center;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"],
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      input[type="text"]:focus,
      input[type="email"]:focus,
      input[type="password"]:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .btn-student {
        background: #667eea;
        color: white;
      }

      .btn-student:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-instructor {
        background: #764ba2;
        color: white;
      }

      .btn-instructor:hover {
        background: #6a3f8f;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(118, 75, 162, 0.3);
      }

      .btn-register {
        background: #667eea;
        color: white;
      }

      .btn-register:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .response-container {
        margin-top: 30px;
        display: none;
        padding: 20px;
        border-radius: 8px;
        background: #f5f5f5;
        border-left: 4px solid #667eea;
      }

      .response-container.error {
        border-left-color: #f44336;
        background: #ffebee;
      }

      .response-container.success {
        border-left-color: #4caf50;
        background: #e8f5e9;
      }

      .response-container h3 {
        margin-bottom: 10px;
        color: #333;
        font-size: 16px;
      }

      .response-content {
        font-size: 13px;
        font-family: "Monaco", "Courier New", monospace;
        color: #666;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        padding: 12px;
        border-radius: 4px;
        line-height: 1.5;
      }

      .response-content.error {
        color: #c62828;
      }

      .response-content.success {
        color: #2e7d32;
      }

      .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #ddd;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .example-emails {
        background: #f0f4ff;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 13px;
        color: #555;
      }

      .example-emails h4 {
        color: #333;
        margin-bottom: 8px;
      }

      .example-emails p {
        margin: 5px 0;
        font-family: "Monaco", "Courier New", monospace;
        color: #667eea;
      }

      .divider {
        text-align: center;
        margin: 20px 0;
        color: #ccc;
      }

      .password-requirements {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-top: 8px;
        border: 2px solid #e0e0e0;
        display: none;
      }

      .password-requirements.show {
        display: block;
      }

      .password-requirements h5 {
        color: #333;
        font-size: 12px;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-weight: 600;
      }

      .requirement-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 13px;
        color: #666;
      }

      .requirement-item:last-child {
        margin-bottom: 0;
      }

      .requirement-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        font-weight: bold;
        font-size: 12px;
        flex-shrink: 0;
      }

      .requirement-icon.met {
        background: #4caf50;
        color: white;
      }

      .requirement-icon.unmet {
        background: #f44336;
        color: white;
      }

      .requirement-text {
        flex: 1;
      }

      .password-strength-bar {
        width: 100%;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        margin-top: 10px;
        overflow: hidden;
      }

      .password-strength-fill {
        height: 100%;
        width: 0%;
        transition:
          width 0.3s,
          background-color 0.3s;
        border-radius: 2px;
      }

      .password-strength-fill.weak {
        width: 25%;
        background: #f44336;
      }

      .password-strength-fill.fair {
        width: 50%;
        background: #ff9800;
      }

      .password-strength-fill.good {
        width: 75%;
        background: #ffc107;
      }

      .password-strength-fill.strong {
        width: 100%;
        background: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéì UAPMP Registration Test</h1>
      <p class="subtitle">
        Role auto-detected from email format (student or instructor)
      </p>

      <div class="form-group">
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" placeholder="e.g., Ahmed Ali" />
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="email"
          id="email"
          placeholder="e.g., 2024001@std.sci.cu.edu.eg"
        />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input
          type="password"
          id="password"
          placeholder="Minimum 6 characters"
          oninput="checkPasswordStrength()"
        />
        <div id="passwordRequirements" class="password-requirements">
          <h5>Password Requirements:</h5>
          <div class="requirement-item">
            <div class="requirement-icon" id="reqLength">‚úó</div>
            <div class="requirement-text">At least 6 characters</div>
          </div>
          <div class="requirement-item">
            <div class="requirement-icon" id="reqLetter">‚úó</div>
            <div class="requirement-text">Contains letters (a-z, A-Z)</div>
          </div>
          <div class="requirement-item">
            <div class="requirement-icon" id="reqDigit">‚úó</div>
            <div class="requirement-text">Contains digits (0-9)</div>
          </div>
          <div class="requirement-item">
            <div class="requirement-icon" id="reqSpecial">‚úó</div>
            <div class="requirement-text">
              Contains special character (!@#$%^&*)
            </div>
          </div>
          <div class="password-strength-bar">
            <div id="strengthFill" class="password-strength-fill"></div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input
          type="password"
          id="confirmPassword"
          placeholder="Repeat password"
        />
      </div>

      <div class="button-group">
        <button
          class="btn-register"
          onclick="register()"
          style="grid-column: 1 / -1"
        >
          Register
        </button>
      </div>

      <div class="divider">‚îÄ‚îÄ‚îÄ</div>

      <!-- LOGIN SECTION -->
      <h2 style="text-align: center; margin: 20px 0 10px; color: #fff">
        Login
      </h2>
      <div
        style="
          background: white;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
        "
      >
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input
            type="email"
            id="loginEmail"
            placeholder="e.g., 2024001@std.sci.cu.edu.eg"
          />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input
            type="password"
            id="loginPassword"
            placeholder="Your password"
          />
        </div>
        <div class="button-group">
          <button class="btn-student" onclick="login()">Login</button>
        </div>
      </div>

      <div class="example-emails">
        <h4>üìß Example Emails:</h4>
        <p><strong>Student:</strong> 2024001@std.sci.cu.edu.eg</p>
        <p><strong>Instructor:</strong> khan@sci.cu.edu.eg</p>
        <p style="margin-top: 10px; font-size: 12px; color: #999">
          ‚ÑπÔ∏è Role is auto-detected from email format
        </p>
      </div>

      <div id="responseContainer" class="response-container">
        <h3 id="responseTitle">Response</h3>
        <div id="responseContent" class="response-content"></div>
      </div>
    </div>

    <script src="../config.js"></script>
    <script>
      // if already authenticated, skip to dashboard automatically
      (function checkAlreadyLoggedIn() {
        const token = localStorage.getItem("token");
        const userJson = localStorage.getItem("user");
        if (token && userJson) {
          try {
            const user = JSON.parse(userJson);
            const dest =
              user.role === "student"
                ? "student-profile.html"
                : "instructor-profile.html";
            window.location.href = dest;
          } catch (e) {
            console.warn("invalid user data, clearing storage", e.message);
            localStorage.removeItem("token");
            localStorage.removeItem("user");
          }
        }
      })();

      // API Configuration references
      const API_URL = API_CONFIG.getRegisterUrl();
      const LOGIN_URL = API_CONFIG.getLoginUrl();

      // Check password strength and show requirements
      function checkPasswordStrength() {
        const password = document.getElementById("password").value;
        const requirementsContainer = document.getElementById(
          "passwordRequirements",
        );

        if (password.length === 0) {
          requirementsContainer.classList.remove("show");
          return;
        }

        requirementsContainer.classList.add("show");

        // Check requirements
        const hasLength = password.length >= 6;
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasDigit = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        // Update requirement indicators
        updateRequirement("reqLength", hasLength);
        updateRequirement("reqLetter", hasLetter);
        updateRequirement("reqDigit", hasDigit);
        updateRequirement("reqSpecial", hasSpecial);

        // Calculate strength
        const metRequirements = [
          hasLength,
          hasLetter,
          hasDigit,
          hasSpecial,
        ].filter((req) => req).length;
        updateStrengthBar(metRequirements);
      }

      // Update individual requirement
      function updateRequirement(elementId, isMet) {
        const element = document.getElementById(elementId);
        if (isMet) {
          element.classList.remove("unmet");
          element.classList.add("met");
          element.textContent = "‚úì";
        } else {
          element.classList.remove("met");
          element.classList.add("unmet");
          element.textContent = "‚úó";
        }
      }

      // Update strength bar
      function updateStrengthBar(metRequirements) {
        const strengthFill = document.getElementById("strengthFill");
        strengthFill.className = "password-strength-fill";

        if (metRequirements === 0) {
          strengthFill.classList.add("weak");
        } else if (metRequirements === 1) {
          strengthFill.classList.add("weak");
        } else if (metRequirements === 2) {
          strengthFill.classList.add("fair");
        } else if (metRequirements === 3) {
          strengthFill.classList.add("good");
        } else if (metRequirements === 4) {
          strengthFill.classList.add("strong");
        }
      }

      async function register() {
        const fullName = document.getElementById("fullName").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        // Validation
        if (!fullName || !email || !password || !confirmPassword) {
          showResponse("All fields are required!", true);
          return;
        }

        if (password !== confirmPassword) {
          showResponse("Passwords do not match!", true);
          return;
        }

        // Validate password strength
        const hasLength = password.length >= 6;
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasDigit = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasLength || !hasLetter || !hasDigit || !hasSpecial) {
          let missingRequirements = [];
          if (!hasLength) missingRequirements.push("at least 6 characters");
          if (!hasLetter) missingRequirements.push("letters (a-z, A-Z)");
          if (!hasDigit) missingRequirements.push("digits (0-9)");
          if (!hasSpecial)
            missingRequirements.push("special character (!@#$%^&*)");

          showResponse(
            `‚ùå Password must contain: ${missingRequirements.join(", ")}`,
            true,
          );
          return;
        }

        // Make request
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              fullName,
              email,
              password,
              confirmPassword,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            // Store user data for later use
            const userData = data.user;
            localStorage.setItem("user", JSON.stringify(userData));

            // Show success message with verification instructions
            showResponse(
              `‚úÖ Registration successful!\n\nüìß Check your email for a verification link.\n\nClick the link to access your ${userData.role === "student" ? "student" : "instructor"} dashboard.\n\n‚ö†Ô∏è Note: The link will expire in 24 hours.`,
              false,
            );

            clearForm();
          } else {
            showResponse(JSON.stringify(data, null, 2), true);
          }
        } catch (error) {
          showResponse(
            `Error: ${error.message}\n\nMake sure the server is running on http://localhost:5000`,
            true,
          );
        }
      }

      async function login() {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          showResponse("Email and password are required for login", true);
          return;
        }

        try {
          const response = await fetch(LOGIN_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
            showResponse("‚úÖ Login successful ‚Äî redirecting...", false);
            setTimeout(() => {
              const dest =
                data.user.role === "student"
                  ? "student-profile.html"
                  : "instructor-profile.html";
              window.location.href = dest;
            }, 800);
          } else {
            showResponse(JSON.stringify(data, null, 2), true);
          }
        } catch (err) {
          showResponse(
            `Error: ${err.message}\n\nMake sure the server is running on http://localhost:5000`,
            true,
          );
        }
      }

      function showResponse(message, isError) {
        const container = document.getElementById("responseContainer");
        const content = document.getElementById("responseContent");
        const title = document.getElementById("responseTitle");

        title.textContent = isError ? "‚ùå Error" : "‚úÖ Success";
        content.textContent = message;
        content.className = isError
          ? "response-content error"
          : "response-content success";

        if (isError) {
          container.className = "response-container error";
        } else {
          container.className = "response-container success";
        }

        container.style.display = "block";
        container.scrollIntoView({ behavior: "smooth" });
      }

      function clearForm() {
        document.getElementById("fullName").value = "";
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
        document.getElementById("confirmPassword").value = "";
      }

      // Allow Enter key to submit
      document.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          register();
        }
      });
    </script>
  </body>
</html>
